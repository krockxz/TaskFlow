generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Task {
  id                String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title             String
  description       String?
  status            TaskStatus?    @default(OPEN) @map("status")
  priority          TaskPriority?  @default(MEDIUM) @map("priority")
  createdById       String         @map("created_by_id") @db.Uuid
  assignedTo        String?        @map("assigned_to") @db.Uuid
  createdAt         DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime       @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // GitHub Integration
  githubIssueUrl    String?        @map("github_issue_url") @db.Text
  githubIssueNumber Int?          @map("github_issue_number") @db.Integer
  githubPrUrl       String?        @map("github_pr_url") @db.Text
  githubRepo        String?        @map("github_repo") @db.Text

  // Relations
  createdBy   User         @relation("CreatedBy", fields: [createdById], references: [id])
  assignedToUser User?     @relation("AssignedTo", fields: [assignedTo], references: [id])
  events      TaskEvent[]
  notifications Notification[]

  @@index([status], map: "idx_tasks_status")
  @@index([githubRepo], map: "idx_tasks_github_repo")
  @@map("tasks")
}

model TaskEvent {
  id            String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  taskId        String     @map("task_id") @db.Uuid
  eventType     EventType  @map("event_type")
  oldStatus     String?    @map("old_status")
  newStatus     String?    @map("new_status")
  changedById   String     @map("changed_by_id") @db.Uuid
  createdAt     DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  changedBy   User    @relation(fields: [changedById], references: [id])

  @@map("task_events")
}

model Notification {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  taskId    String    @map("task_id") @db.Uuid
  message   String
  read      Boolean   @default(false)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([createdAt], map: "idx_notifications_created_at")
  @@map("notifications")
}

model User {
  id            String    @id @db.Uuid
  email         String    @unique
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  createdTasks  Task[]    @relation("CreatedBy")
  assignedTasks Task[]    @relation("AssignedTo")
  createdEvents TaskEvent[]
  notifications Notification[]

  @@map("users")
}

enum EventType {
  CREATED
  ASSIGNED
  STATUS_CHANGED
  COMPLETED
  PRIORITY_CHANGED
  @@map("event_type")
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  @@map("task_priority")
}

enum TaskStatus {
  OPEN
  IN_PROGRESS
  READY_FOR_REVIEW
  DONE
  @@map("task_status")
}
