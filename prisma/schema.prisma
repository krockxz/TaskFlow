// Prisma Schema for TaskFlow
// Database: PostgreSQL (Supabase)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// SUPABASE AUTH MODELS (Managed by Supabase - don't modify)
// ============================================================================
// Note: When using Supabase Auth, auth tables are managed automatically
// This User model references Supabase Auth users (id matches auth.uid())

// ============================================================================
// TASKFLOW MODELS
// ============================================================================

model Task {
  id          String      @id @default(uuid())
  title       String
  description String?     @db.Text
  status      TaskStatus  @default(OPEN)
  priority    TaskPriority @default(MEDIUM)

  // Foreign keys
  createdById String
  assignedTo  String?

  // Relations
  createdBy   User         @relation("CreatedBy", fields: [createdById], references: [id])
  assignedToUser User?     @relation("AssignedTo", fields: [assignedTo], references: [id])
  events      TaskEvent[]
  notifications Notification[]

  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  @@index([assignedTo])
  @@index([status])
  @@index([createdById])
  @@map("tasks")
}

model TaskEvent {
  id        String   @id @default(uuid())
  taskId    String
  eventType EventType

  oldStatus String?  @map("old_status")
  newStatus String?  @map("new_status")

  changedById String
  changedBy   User    @relation(fields: [changedById], references: [id])

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([changedById])
  @@map("task_events")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  taskId    String

  message   String   @db.Text
  read      Boolean  @default(false)

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([createdAt])
  @@map("notifications")
}

// ============================================================================
// USER MODEL (References Supabase Auth users)
// ============================================================================

model User {
  id            String    @id // Matches Supabase Auth user.id
  email         String    @unique
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  createdTasks  Task      @relation("CreatedBy")
  assignedTasks Task      @relation("AssignedTo")
  createdEvents TaskEvent[]
  notifications Notification[]

  @@map("users")
}

// ============================================================================
// ENUMS
// ============================================================================

enum TaskStatus {
  OPEN
  IN_PROGRESS
  READY_FOR_REVIEW
  DONE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

enum EventType {
  CREATED
  ASSIGNED
  STATUS_CHANGED
  COMPLETED
  PRIORITY_CHANGED
}
