generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model HandoffTemplate {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  description String?  @db.Text
  steps       Json     @default("[]")
  createdById String   @map("created_by_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  createdBy  User              @relation(fields: [createdById], references: [id])
  tasks      Task[]

  @@index([createdById], map: "idx_handoff_templates_created_by_id")
  @@map("handoff_templates")
}

model Task {
  id                String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title             String
  description       String?
  status            TaskStatus?    @default(OPEN) @map("status")
  priority          TaskPriority?  @default(MEDIUM) @map("priority")
  dueDate           DateTime?      @map("due_date") @db.Timestamptz(6)
  createdById       String         @map("created_by_id") @db.Uuid
  assignedTo        String?        @map("assigned_to") @db.Uuid
  createdAt         DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime       @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // GitHub Integration
  githubIssueUrl    String?        @map("github_issue_url") @db.Text
  githubIssueNumber Int?          @map("github_issue_number") @db.Integer
  githubPrUrl       String?        @map("github_pr_url") @db.Text
  githubRepo        String?        @map("github_repo") @db.Text

  // Handoff Templates
  templateId       String?  @map("template_id") @db.Uuid
  customFields     Json?    @map("custom_fields")
  timezone         String?  @map("timezone") @db.Text

  // Relations
  createdBy   User         @relation("CreatedBy", fields: [createdById], references: [id])
  assignedToUser User?     @relation("AssignedTo", fields: [assignedTo], references: [id])
  template         HandoffTemplate? @relation(fields: [templateId], references: [id])
  events      TaskEvent[]
  notifications Notification[]

  @@index([status], map: "idx_tasks_status")
  @@index([createdById], map: "idx_tasks_created_by_id")
  @@index([assignedTo], map: "idx_tasks_assigned_to")
  @@index([githubRepo], map: "idx_tasks_github_repo")
  @@index([templateId], map: "idx_tasks_template_id")
  @@map("tasks")
}

model TaskEvent {
  id            String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  taskId        String     @map("task_id") @db.Uuid
  eventType     EventType  @map("event_type")
  oldStatus     String?    @map("old_status")
  newStatus     String?    @map("new_status")
  changedById   String     @map("changed_by_id") @db.Uuid
  createdAt     DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  changedBy   User    @relation(fields: [changedById], references: [id])

  @@map("task_events")
}

model Notification {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  taskId    String    @map("task_id") @db.Uuid
  message   String
  read      Boolean   @default(false)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([createdAt], map: "idx_notifications_created_at")
  @@map("notifications")
}

model User {
  id            String    @id @db.Uuid
  email         String    @unique
  timezone      String?   @db.Text
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  createdTasks  Task[]    @relation("CreatedBy")
  assignedTasks Task[]    @relation("AssignedTo")
  createdEvents TaskEvent[]
  notifications Notification[]
  githubTokens  GitHubToken[]
  slackInstallments SlackInstallation[]
  handoffTemplates HandoffTemplate[]

  @@map("users")
}

model GitHubToken {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  encryptedToken String @map("encrypted_token") @db.Text
  githubLogin  String?  @map("github_login")
  githubAvatar String?  @map("github_avatar")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_github_tokens_user_id")
  @@map("github_tokens")
}

model SlackInstallation {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  teamId            String   @unique @map("team_id") @db.Text
  enterpriseId      String?  @map("enterprise_id") @db.Text
  userId            String   @map("user_id") @db.Uuid
  accessToken       String   @map("access_token") @db.Text
  refreshToken      String?  @map("refresh_token") @db.Text
  botAccessToken    String   @map("bot_access_token") @db.Text
  botRefreshToken   String?  @map("bot_refresh_token") @db.Text
  scope             String   @db.Text
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id])

  @@index([teamId], map: "idx_slack_installations_team_id")
  @@index([userId], map: "idx_slack_installations_user_id")
  @@map("slack_installations")
}

enum EventType {
  CREATED
  ASSIGNED
  STATUS_CHANGED
  COMPLETED
  PRIORITY_CHANGED
  @@map("event_type")
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  @@map("task_priority")
}

enum TaskStatus {
  OPEN
  IN_PROGRESS
  READY_FOR_REVIEW
  DONE
  @@map("task_status")
}
